<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>åŸºç£å ‚ä¸­å­¦å¼€æ”¾æ—¥ï½œæˆè¯­æ‹¼æ‹¼ä¹</title>
<style>
  :root{
    --bg:#faf4e1;
    --ink:#3b2f2a;
    --accent:#c95b16;
    --chip:#ffe0b2;
    --chip-border:#f4c48e;
    --slot:#ffffff;
    --ok:#2e7d32;
    --offset: 10vh; /* æ§åˆ¶æ•´ä½“ä¸Šä¸‹ä½ç½® */
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"Noto Sans SC", system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
    display:flex; flex-direction:column; align-items:center; padding:18px 12px;
  }

  /* èˆå°å®¹å™¨ï¼šæ•´ä½“ä½ç½® + æ”¾å¤§æ¯”ä¾‹ */
  .stage{
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    margin-top: var(--offset);
    transform: scale(1.2);
    transform-origin: top center;
  }

  .title-1{font-size: clamp(22px, 5vw, 36px); font-weight:900; margin:2px 0; color:#2f3e46}
  .title-2{font-size: clamp(20px, 4.4vw, 30px); font-weight:800; margin:4px 0 8px; color:var(--accent)}
  .sub{font-size: clamp(14px, 2.7vw, 18px); opacity:.9; margin:2px 0 12px}

  #idiom-slot{display:flex;justify-content:center;gap:12px;margin:8px 0 6px;min-height:72px;}
  .slot{
    width:76px;height:76px;background:var(--slot);border:3px dashed #b7b7b7;border-radius:16px;
    display:flex;align-items:center;justify-content:center;font-size:46px;font-weight:800;user-select:none;
    box-shadow:0 1px 0 rgba(0,0,0,.04);
    cursor:pointer;            /* ä¿æŒåŸå¤–è§‚ */
    touch-action:none;         /* è§¦å±æ‹–æ‹½æ—¶é˜²æ­¢é¡µé¢æ»šåŠ¨ */
  }

  #choices{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin:14px auto;max-width:900px;}
  .char{
    min-width:64px;min-height:64px;padding:10px 16px;font-size:34px;font-weight:800;
    background:var(--chip);border:2px solid var(--chip-border);border-radius:14px;
    display:inline-flex;align-items:center;justify-content:center;user-select:none;
    transition:transform .06s ease; cursor:grab;
    -webkit-user-drag: element;
    touch-action:none;          /* è§¦å±æ‹–æ‹½æ—¶é˜²æ­¢é¡µé¢æ»šåŠ¨ */
  }
  .char:active{transform:scale(.96)}
  .char[aria-disabled="true"]{opacity:.35;cursor:not-allowed}

  #controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:6px 0 2px}
  button{
    appearance:none;border:0;border-radius:12px;padding:12px 16px;font-size:16px;font-weight:800;cursor:pointer;
    background:var(--accent);color:#fff;box-shadow:0 2px 0 rgba(0,0,0,.08);
  }
  button.secondary{background:#e2b887;color:#3a2b21}

  #feedback{min-height:28px;margin:8px 0 2px;font-weight:900;font-size:20px;color:var(--ok);text-align:center}

  #win-overlay{
    position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.25);z-index:20;
  }
  .win-card{
    background:#fff;padding:22px 20px;border-radius:18px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.18);
    animation:pop .4s ease;
  }
  .win-title{font-size:38px;font-weight:900;color:var(--accent);margin:2px 0 8px}
  .win-note{font-size:18px;margin:0 0 14px}
  .win-btn{margin-top:4px;font-size:16px}
  @keyframes pop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}

  .confetti{
    position:fixed;top:-10px;width:10px;height:16px;background:hsl(var(--h) 80% 60%);
    left:var(--x);transform:rotate(var(--r));
    animation:fall linear forwards;z-index:25;border-radius:2px;
  }
  @keyframes fall{to{transform:translateY(110vh) rotate(calc(var(--r) + 1turn));opacity:.9}}

  @media (min-width:900px){
    .slot{width:86px;height:86px;font-size:50px}
    .char{min-width:70px;min-height:70px;font-size:38px}
    .stage{ margin-top: calc(var(--offset) + 2vh); }
  }

  /* è§¦å±â€œè·Ÿéšå¡ç‰‡â€ */
  .follow-card{
    position:fixed; left:0; top:0; transform:translate(-9999px,-9999px);
    z-index:1000; pointer-events:none;
    will-change: transform;    /* è®©ç§»åŠ¨æ›´ä¸æ»‘ */
  }
</style>
</head>
<body>

  <!-- å¯é€‰ï¼šå¦‚æœä½ æ›´å–œæ¬¢ç”¨è‡ªå·±çš„ mp3 éŸ³æ•ˆï¼ŒæŠŠä¸‹é¢è¿™è¡Œè§£å¼€æ³¨é‡Šï¼Œå¹¶æŠŠæ–‡ä»¶æ”¾åŒä¸€æ–‡ä»¶å¤¹ -->
  <!-- <audio id="win-audio" src="win.mp3" preload="auto"></audio> -->

  <div class="stage">
    <div class="title-1">åŸºç£å ‚ä¸­å­¦å¼€æ”¾æ—¥</div>
    <div class="title-2">æˆè¯­æ‹¼æ‹¼ä¹</div>
    <p class="sub">æŠŠä¸‹æ–¹å­—å¡æ‹–æ‹½åˆ°ä¸Šæ–¹æ–¹æ ¼ï¼›æŠŠæ–¹æ ¼é‡Œçš„å­—æ‹–å›ä¸‹æ–¹å¯æ’¤å›ã€‚æ‹¼å‡ºæ­£ç¡®æˆè¯­å³å¯è·èƒœï¼</p>

    <div id="idiom-slot"></div>
    <div id="choices"></div>

    <div id="controls">
      <button id="resetBtn" class="secondary">æ¢ä¸€é¢˜</button>
    </div>

    <div id="feedback"></div>
  </div>

  <div id="win-overlay">
    <div class="win-card">
      <div class="win-title">ğŸ‰ æ­å–œä½ ï¼</div>
      <p class="win-note">ä½ æˆåŠŸæ‹¼å‡ºäº†æ­£ç¡®çš„æˆè¯­ï¼</p>
      <button class="win-btn" id="againBtn">å†ç©ä¸€æ¬¡</button>
    </div>
  </div>

<script>
/* ------------------ é¢˜åº“ï¼ˆé¡ºåºå‡ºé¢˜ï¼‰ ------------------ */
const IDIOMS = [
  "ç”»è›‡æ·»è¶³","ç‹å‡è™å¨","äº•åº•ä¹‹è›™","å®ˆæ ªå¾…å…”","åŠé€”è€ŒåºŸ",
  "ä¸‰å¿ƒäºŒæ„","ä¸€å¿ƒä¸€æ„","ä¸¾ä¸€åä¸‰","ä¸åŠ³è€Œè·","è‡ªä½œè‡ªå—",
  "æ‰‹å¿™è„šä¹±","èƒ¸æœ‰æˆç«¹","ç”»é¾™ç‚¹ç›","å¯¹ç‰›å¼¹ç´","æ‹”è‹—åŠ©é•¿",
  "ä¸œå¼ è¥¿æœ›","ç›®ä¸è½¬ç›","æ´¥æ´¥æœ‰å‘³","çˆ±ä¸é‡Šæ‰‹","åŒå¿ƒååŠ›","ä¸€å¸†é£é¡º",
  "äººå±±äººæµ·","é’ˆé”‹ç›¸å¯¹"
];
const POOL_EXTRA =
  "æ˜¥æš–èŠ±å¼€æ—¥æ–°æœˆå¼‚é¾™è…¾è™è·ƒç²¾ç›Šæ±‚ç²¾æ°´è½çŸ³å‡ºæ— å¾®ä¸è‡³ååˆ—å‰èŒ…è’¸è’¸æ—¥ä¸Šå¿ƒèŠ±æ€’æ”¾ä¸‡ç´«åƒçº¢ç”Ÿé¾™æ´»è™é£å’Œæ—¥ä¸½";
const POOL_SIZE = 10;

/* ------------------ çŠ¶æ€ ------------------ */
let TARGET_IDIOM = "";
let choicesData = [];        // [{ch, used, el}]
let slotMap = [null, null, null, null]; // æ¯ä¸ªæ§½ä½é‡Œå­˜æ”¾ choicesData çš„ç´¢å¼•
let currentIndex = 0;        // é¡ºåºå‡ºé¢˜æŒ‡é’ˆ
let won = false;

const slotBox = document.getElementById("idiom-slot");
const choicesBox = document.getElementById("choices");
const feedback = document.getElementById("feedback");
const resetBtn = document.getElementById("resetBtn");
const winOverlay = document.getElementById("win-overlay");
const againBtn = document.getElementById("againBtn");

/* ---------- éŸ³æ•ˆï¼šWeb Audioï¼ˆæ— éœ€éŸ³é¢‘æ–‡ä»¶ï¼‰ ---------- */
let audioCtx = null;
function getAudioCtx(){
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if (audioCtx.state === "suspended") audioCtx.resume();
  return audioCtx;
}

function playWinSound(){
  const ctx = getAudioCtx();
  const now = ctx.currentTime;

  const freqs = [784, 988]; // G5, B5
  freqs.forEach((f, i) => {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "sine";
    osc.frequency.setValueAtTime(f, now);
    osc.frequency.exponentialRampToValueAtTime(f * 1.08, now + 0.18 + i*0.02);
    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(0.35, now + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.38 + i*0.02);
    osc.connect(gain).connect(ctx.destination);
    osc.start(now + i*0.005);
    osc.stop(now + 0.45 + i*0.02);
  });

  const clickOsc = ctx.createOscillator();
  const clickGain = ctx.createGain();
  clickOsc.type = "triangle";
  clickOsc.frequency.setValueAtTime(1568, now); // G6
  clickGain.gain.setValueAtTime(0.0001, now);
  clickGain.gain.exponentialRampToValueAtTime(0.25, now + 0.01);
  clickGain.gain.exponentialRampToValueAtTime(0.001, now + 0.12);
  clickOsc.connect(clickGain).connect(ctx.destination);
  clickOsc.start(now + 0.02);
  clickOsc.stop(now + 0.14);
}

/* ------------------------------------------------------ */
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}

function buildPool(){
  const need = Math.max(POOL_SIZE - 4, 0);
  const extras = Array.from(POOL_EXTRA).filter(ch=>!TARGET_IDIOM.includes(ch));
  shuffle(extras);
  const pool = [...TARGET_IDIOM, ...extras.slice(0, need)];
  shuffle(pool);
  return pool;
}

/* ------------------ æ¸²æŸ“ ------------------ */
function render(){
  const slots = slotBox.querySelectorAll(".slot");
  slots.forEach((s, i) => {
    const idx = slotMap[i];
    s.textContent = (idx != null) ? choicesData[idx].ch : "";
    s.draggable = (idx != null) && !won; // æ¡Œé¢ DnD
  });

  choicesData.forEach(it=>{
    const used = it.used;
    it.el.setAttribute("aria-disabled", used ? "true" : "false");
    it.el.style.opacity = used ? ".35" : "1";
    it.el.draggable = !used && !won; // æ¡Œé¢ DnD
  });

  if (slotMap.every(v=>v!=null) && !won) checkAnswer();
}

/* ------------------ æ¡Œé¢ DnDï¼ˆåŸç”Ÿï¼‰ ------------------ */
function enableDesktopDnDForSlot(slotEl, i){
  slotEl.addEventListener("dragover", (e)=>{
    if (won) return;
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  });
  slotEl.addEventListener("drop",(e)=>{
    if (won) return;
    e.preventDefault();
    const type = e.dataTransfer.getData("type");
    if (type === "choice"){
      const cidx = parseInt(e.dataTransfer.getData("idx"), 10);
      if (Number.isNaN(cidx)) return;
      if (slotMap[i]!=null){
        const occupied = slotMap[i];
        choicesData[occupied].used = false;
      }
      slotMap[i] = cidx;
      choicesData[cidx].used = true;
      render();
    } else if (type === "slot"){
      const from = parseInt(e.dataTransfer.getData("sidx"), 10);
      if (Number.isNaN(from) || from === i) return;
      const tmp = slotMap[i];
      slotMap[i] = slotMap[from];
      slotMap[from] = tmp;
      render();
    }
  });
  slotEl.addEventListener("dragstart",(e)=>{
    if (won || slotMap[i]==null){ e.preventDefault(); return; }
    e.dataTransfer.setData("type","slot");
    e.dataTransfer.setData("sidx", String(i));
    e.dataTransfer.effectAllowed = "move";
  });
}

function enableDesktopDnDForChoice(div, idx){
  div.addEventListener("dragstart",(e)=>{
    const item = choicesData[idx];
    if (item.used || won){ e.preventDefault(); return; }
    e.dataTransfer.setData("type","choice");
    e.dataTransfer.setData("idx", String(idx));
    e.dataTransfer.effectAllowed = "move";
  });
}

/* ------------------ è§¦å±æ‹–æ‹½ï¼ˆPointer Events é™çº§ï¼‰ ------------------ */
let followCard = null;
let dragging = null; // { kind: 'choice'|'slot', idx: number }
let pointerId = null;

function createFollowCard(text){
  const el = document.createElement("div");
  el.className = "char follow-card";
  el.textContent = text;
  document.body.appendChild(el);
  return el;
}
function moveFollowCard(x,y){
  if (!followCard) return;
  followCard.style.transform = `translate(${x - followCard.offsetWidth/2}px, ${y - followCard.offsetHeight/2}px)`;
}
function cleanupFollow(){
  if (followCard && followCard.parentNode) followCard.parentNode.removeChild(followCard);
  followCard = null;
  dragging = null;
  pointerId = null;
}

function startPointerDragFromChoice(e, idx){
  if (e.pointerType !== 'touch') return;   // åªå¤„ç†è§¦æ§
  const item = choicesData[idx];
  if (item.used || won) return;
  dragging = {kind:'choice', idx};
  pointerId = e.pointerId;
  followCard = createFollowCard(item.ch);
  e.currentTarget.setPointerCapture(pointerId);
  moveFollowCard(e.clientX, e.clientY);
  e.preventDefault();
}
function startPointerDragFromSlot(e, sidx){
  if (e.pointerType !== 'touch') return;   // åªå¤„ç†è§¦æ§
  if (won || slotMap[sidx]==null) return;
  const cidx = slotMap[sidx];
  dragging = {kind:'slot', idx:sidx};
  pointerId = e.pointerId;
  followCard = createFollowCard(choicesData[cidx].ch);
  e.currentTarget.setPointerCapture(pointerId);
  moveFollowCard(e.clientX, e.clientY);
  e.preventDefault();
}
function pointerMove(e){
  if (!dragging || e.pointerId!==pointerId) return;
  moveFollowCard(e.clientX, e.clientY);
}
function pointerUp(e){
  if (!dragging || e.pointerId!==pointerId) return;
  const target = document.elementFromPoint(e.clientX, e.clientY);
  const slotEl = target?.closest?.(".slot");
  const inChoices = target?.closest?.("#choices");

  if (dragging.kind === 'choice'){
    const cidx = dragging.idx;
    if (slotEl){
      const i = [...slotBox.querySelectorAll(".slot")].indexOf(slotEl);
      if (i>=0){
        if (slotMap[i]!=null){
          const occupied = slotMap[i];
          choicesData[occupied].used = false;
        }
        slotMap[i] = cidx;
        choicesData[cidx].used = true;
      }
    }
  }else if (dragging.kind === 'slot'){
    const from = dragging.idx;
    if (slotEl){
      const i = [...slotBox.querySelectorAll(".slot")].indexOf(slotEl);
      if (i>=0 && i!==from){
        const tmp = slotMap[i];
        slotMap[i] = slotMap[from];
        slotMap[from] = tmp;
      }
    }else if (inChoices){
      const cidx = slotMap[from];
      choicesData[cidx].used = false;
      slotMap[from] = null;
    }
  }

  cleanupFollow();
  render();
}

/* ------------------ ç»„ä»¶ç”Ÿæˆ ------------------ */
function makeSlot(i){
  const slot = document.createElement("div");
  slot.className = "slot";

  // æ¡Œé¢ DnD
  enableDesktopDnDForSlot(slot, i);

  // è§¦å± Pointerï¼ˆå§‹ç»ˆæ³¨å†Œï¼Œå†…éƒ¨è¿‡æ»¤ pointerTypeï¼‰
  slot.addEventListener("pointerdown", (e)=> startPointerDragFromSlot(e, i));
  slot.addEventListener("pointermove", pointerMove);
  slot.addEventListener("pointerup", pointerUp);
  slot.addEventListener("pointercancel", cleanupFollow);

  return slot;
}

function loadGame(){
  won = false;
  feedback.textContent="";
  winOverlay.style.display="none";
  slotBox.innerHTML="";
  choicesBox.innerHTML="";
  slotMap = [null,null,null,null];

  TARGET_IDIOM = IDIOMS[currentIndex % IDIOMS.length];
  currentIndex = (currentIndex + 1) % IDIOMS.length;

  for(let i=0;i<4;i++){
    slotBox.appendChild( makeSlot(i) );
  }

  const pool = buildPool();
  choicesData = pool.map(ch=>({ch, used:false, el:null}));
  choicesData.forEach((item, idx)=>{
    const div = document.createElement("div");
    div.className = "char";
    div.textContent = item.ch;

    // æ¡Œé¢ DnD
    enableDesktopDnDForChoice(div, idx);

    // è§¦å± Pointerï¼ˆå§‹ç»ˆæ³¨å†Œï¼Œå†…éƒ¨è¿‡æ»¤ pointerTypeï¼‰
    div.addEventListener("pointerdown", (e)=> startPointerDragFromChoice(e, idx));
    div.addEventListener("pointermove", pointerMove);
    div.addEventListener("pointerup", pointerUp);
    div.addEventListener("pointercancel", cleanupFollow);

    item.el = div;
    choicesBox.appendChild(div);
  });

  render();
}

function checkAnswer(){
  const attempt = slotMap.map(i=>choicesData[i].ch).join("");
  if (attempt === TARGET_IDIOM){
    feedback.textContent="âœ… å¤ªæ£’äº†ï¼";
    showWin();
  }else{
    feedback.textContent="âŒ å†è¯•ä¸€æ¬¡ï¼æŠŠå­—æ‹–å›ä¸‹æ–¹å¯æ’¤å›é‡æ’ã€‚";
  }
}

function showWin(){
  won = true;
  launchConfetti(100);
  playWinSound();
  setTimeout(()=>{winOverlay.style.display="grid";},300);
}

function launchConfetti(n=80){
  for(let i=0;i<n;i++){
    const el=document.createElement("div");
    el.className="confetti";
    const x=Math.random()*100;
    const h=Math.floor(Math.random()*360);
    const r=(Math.random()*360).toFixed(0)+"deg";
    const dur=(Math.random()*1.5+1.8).toFixed(2);
    el.style.setProperty("--x",x+"vw");
    el.style.setProperty("--h",h);
    el.style.setProperty("--r",r);
    el.style.animationDuration=dur+"s";
    document.body.appendChild(el);
    el.addEventListener("animationend",()=>el.remove());
  }
}

// æŒ‰é’®ï¼šå…ˆè§£é”/æ¢å¤éŸ³é¢‘ï¼Œå†è½½å…¥ä¸‹ä¸€é¢˜ï¼ˆé¡ºåºï¼‰
resetBtn.addEventListener("click", () => { getAudioCtx(); loadGame(); });
againBtn.addEventListener("click", () => { getAudioCtx(); loadGame(); });

// é¦–é¢˜
loadGame();
</script>
</body>
</html>